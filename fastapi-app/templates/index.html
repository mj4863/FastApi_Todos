<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>To-Do List</title>
  <style>
    /* ===== Design Tokens ===== */
    :root{
      --bg:#f6f7fb; --fg:#0f1222; --muted:#6b7280;
      --card:#fff; --border:#e6e8f0; --shadow:0 8px 30px rgba(0,0,0,.06);
      --primary:#6366f1; --primary-weak:#eef2ff; --danger:#ef4444;
      --radius:14px; --ring:0 0 0 3px rgba(99,102,241,.25);
      color-scheme:light dark;
    }
    body.dark{
      --bg:#0b0d14; --fg:#e5e7eb; --muted:#9aa0aa;
      --card:#0f1420; --border:#1f2430; --shadow:0 8px 30px rgba(0,0,0,.4);
      --primary:#8b93ff; --primary-weak:#111634; --danger:#ff6b6b;
      --ring:0 0 0 3px rgba(139,147,255,.25);
    }

    /* ===== Base ===== */
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      color:var(--fg); background:var(--bg);
      display:grid; place-items:start center; padding:clamp(16px,3vw,32px);
    }
    .app{
      width:min(860px,100%); background:var(--card); border:1px solid var(--border);
      border-radius:calc(var(--radius) + 2px); box-shadow:var(--shadow); overflow:hidden;
    }
    header,.toolbar,footer{ padding:16px clamp(16px,3vw,24px); }
    header{ display:flex; gap:10px; align-items:center; border-bottom:1px solid var(--border)}
    h1{ margin:0; font-size:clamp(20px,2.4vw,28px) }
    .badge{ padding:2px 8px; border-radius:999px; border:1px solid var(--border);
      background:var(--primary-weak); color:var(--primary); font-size:12px }

    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; border-bottom:1px solid var(--border)}
    .spacer{ flex:1 1 auto }
    label,select{ font-size:14px; color:var(--muted) }
    select{
      appearance:none; border:1px solid var(--border); background:transparent; color:var(--fg);
      padding:8px 12px; border-radius:10px; outline:none;
    }
    select:focus-visible{ box-shadow:var(--ring) }

    .icon-btn{
      height:36px; width:36px; display:grid; place-items:center; border-radius:50%;
      border:1px solid var(--border); background:transparent; cursor:pointer;
    }
    .icon-btn:hover{ background:var(--primary-weak) }

    #status{
      color:var(--muted); font-size:13px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
    }

    main{ padding:10px clamp(16px,3vw,24px) 20px }

    /* ===== List ===== */
    ul#todo-list{ margin:0; padding:0; list-style:none; display:grid; gap:10px }
    li.todo{
      display:grid; grid-template-columns:auto 1fr auto auto; align-items:center; gap:10px;
      border:1px solid var(--border); border-radius:var(--radius); padding:10px 12px; background:transparent;
    }
    input[type="checkbox"]{ width:20px; height:20px; accent-color:var(--primary); cursor:pointer }
    .text{ overflow:hidden; white-space:nowrap; text-overflow:ellipsis }
    .done .text{ text-decoration:line-through; opacity:.85 }
    .btn{ border:1px solid var(--border); background:transparent; color:var(--fg);
      padding:8px 12px; border-radius:10px; cursor:pointer }
    .btn:hover{ background:var(--primary-weak) }
    .btn.danger{ color:var(--danger); border-color:transparent; background:transparent }
    .btn.danger:hover{ background:rgba(239,68,68,.08) }

    /* ===== Form / Error / Footer ===== */
    form{
      display:grid; grid-template-columns:1fr 1fr auto; gap:10px; align-items:center;
      border-top:1px dashed var(--border); padding-top:14px
    }
    input[type="text"]{
      border:1px solid var(--border); background:transparent; color:var(--fg);
      padding:10px 12px; border-radius:10px; outline:none;
    }
    input[type="text"]::placeholder{ color:var(--muted) }
    input[type="text"]:focus-visible{ box-shadow:var(--ring); border-color:var(--primary) }

    .err{
      margin-top:10px; color:#b00020; background:#ffeff2; border:1px solid #ffd0d8;
      padding:10px 12px; border-radius:10px; display:none
    }
    body.dark .err{ background:#2a0f17; border-color:#3b0f19; color:#ff98a7 }

    footer{ border-top:1px solid var(--border); display:flex; justify-content:space-between; color:var(--muted) }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>To-Do List</h1>
      <span class="badge" id="app-version">v?.?.?</span>
    </header>

    <div class="toolbar">
      <label>
        Filter:
        <select id="filter">
          <option value="all">All</option>
          <option value="true">Completed</option>
          <option value="false">Active</option>
        </select>
      </label>
      <div class="spacer"></div>
      <button id="toggle-theme" class="icon-btn" title="Toggle dark mode">ðŸŒ“</button>
      <span id="status" role="status" aria-live="polite"></span>
    </div>

    <main>
      <ul id="todo-list" role="list"></ul>

      <form id="todo-form" autocomplete="off">
        <input id="title" placeholder="Title" required />
        <input id="description" placeholder="Description" required />
        <button class="btn" type="submit">Add</button>
      </form>

      <div id="error" class="err" role="alert"></div>
    </main>

    <footer>
      <small>Made with FastAPI</small>
      <small>Press ðŸŒ“ to toggle theme</small>
    </footer>
  </div>

  <!-- Template reduces DOM boilerplate -->
  <template id="todo-tpl">
    <li class="todo" data-id="">
      <input class="chk" type="checkbox" />
      <span class="text"></span>
      <button class="btn edit" type="button">Edit</button>
      <button class="btn danger del" type="button">Delete</button>
    </li>
  </template>

  <script>
    // ===== State & Storage =====
    const $ = s => document.querySelector(s);
    const els = {
      list: $("#todo-list"), filter: $("#filter"), status: $("#status"),
      err: $("#error"), ver: $("#app-version"), themeBtn: $("#toggle-theme"),
      form: $("#todo-form"), title: $("#title"), desc: $("#description"),
      tpl: /** @type {HTMLTemplateElement} */ ($("#todo-tpl")),
    };
    const STORE = { FILTER:'todo-filter', THEME:'todo-theme' };
    const state = {
      get filter(){ return localStorage.getItem(STORE.FILTER) || 'all'; },
      set filter(v){ localStorage.setItem(STORE.FILTER, v); },
      get theme(){ return localStorage.getItem(STORE.THEME) || 'light'; },
      set theme(v){ localStorage.setItem(STORE.THEME, v); },
    };
    if (state.theme === 'dark') document.body.classList.add('dark');
    els.filter.value = state.filter;

    // ===== API wrapper =====
    const api = {
      async request(path, opts){
        const r = await fetch(path, { headers:{'Content-Type':'application/json'}, ...opts });
        if (!r.ok){
          let msg = 'Request failed';
          try { const j = await r.json(); msg = j.detail || msg; } catch {}
          throw new Error(msg);
        }
        return r.status === 204 ? null : r.json();
      },
      list(filter){ const qs = filter==='all' ? '' : `?completed=${filter}`; return this.request(`/todos${qs}`); },
      create(todo){ return this.request('/todos', { method:'POST', body:JSON.stringify(todo) }); },
      update(id, todo){ return this.request(`/todos/${id}`, { method:'PUT', body:JSON.stringify(todo) }); },
      remove(id){ return this.request(`/todos/${id}`, { method:'DELETE' }); },
      version(){ return this.request('/version'); }
    };

    // ===== UI helpers =====
    function showError(msg){
      els.err.textContent = msg; els.err.style.display = 'block';
      clearTimeout(showError.tid); showError.tid = setTimeout(()=> els.err.style.display='none', 3000);
    }
    const plural = (n, w) => `${n} ${w}${n===1?'':'s'}`;

    function renderList(todos){
      els.list.textContent = '';
      if (!todos.length){
        const empty = document.createElement('li');
        empty.className = 'todo'; empty.style.borderStyle='dashed'; empty.style.opacity='.7';
        empty.innerHTML = '<span class="text">No items yet. Add your first to-do!</span>';
        els.list.appendChild(empty);
        els.status.textContent = `${plural(0,'item')} â€¢ 0 done`;
        return;
      }
      const frag = document.createDocumentFragment();
      let done = 0;
      for (const t of todos){
        if (t.completed) done++;
        const node = els.tpl.content.firstElementChild.cloneNode(true);
        node.dataset.id = t.id;
        if (t.completed) node.classList.add('done');
        node.querySelector('.chk').checked = !!t.completed;
        node.querySelector('.text').textContent = `${t.title}: ${t.description}`;
        frag.appendChild(node);
      }
      els.list.appendChild(frag);
      els.status.textContent = `${plural(todos.length,'item')} â€¢ ${done} done`;
    }

    // ===== Actions =====
    async function load(){
      try {
        const todos = await api.list(state.filter);
        renderList(todos);
      } catch(e){ showError(e.message); }
    }

    // Delegated list interactions
    els.list.addEventListener('change', async (e)=>{
      const chk = e.target.closest('.chk');
      if (!chk) return;
      const li = e.target.closest('.todo'); const id = Number(li.dataset.id);
      const [title, description] = li.querySelector('.text').textContent.split(': ').map(s=>s ?? '');
      try { await api.update(id, { id, title, description, completed: chk.checked }); load(); }
      catch(err){ showError(err.message); chk.checked = !chk.checked; }
    });

    els.list.addEventListener('click', async (e)=>{
      const li = e.target.closest('.todo'); if (!li) return;
      const id = Number(li.dataset.id);
      if (e.target.closest('.edit')){
        const [curTitle, curDesc] = li.querySelector('.text').textContent.split(': ');
        const title = prompt('Enter new title:', curTitle); if (title===null) return;
        const description = prompt('Enter new description:', curDesc); if (description===null) return;
        try { await api.update(id, { id, title, description, completed: li.classList.contains('done') }); load(); }
        catch(err){ showError(err.message); }
      }
      if (e.target.closest('.del')){
        if (!confirm('Delete this item?')) return;
        try { await api.remove(id); load(); } catch(err){ showError(err.message); }
      }
    });

    els.form.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const title = els.title.value.trim(); const description = els.desc.value.trim();
      if (!title || !description) return showError('Title/Description required');
      const todo = { id: Date.now(), title, description, completed:false };
      try { await api.create(todo); els.form.reset(); els.title.focus(); load(); }
      catch(err){ showError(err.message); }
    });

    els.filter.addEventListener('change', ()=>{ state.filter = els.filter.value; load(); });
    els.themeBtn.addEventListener('click', ()=>{
      document.body.classList.toggle('dark');
      state.theme = document.body.classList.contains('dark') ? 'dark' : 'light';
    });

    // ===== Boot =====
    (async function boot(){
      try { const v = await api.version(); els.ver.textContent = 'v'+(v.version||'unknown'); } catch {}
      await load();
    })();
  </script>
</body>
</html>
