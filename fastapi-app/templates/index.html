<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>To-Do List</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 720px; margin: 40px auto; padding: 0 16px; }
    h1 { margin-bottom: 8px; }
    .toolbar { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; }
    #todo-list li { margin: 6px 0; display: flex; gap: 8px; align-items: center; }
    #todo-list li.done { opacity: .7; text-decoration: line-through; }
    small.muted { color: #666; }
    footer { margin-top: 24px; color: #666; }
    button { cursor: pointer; }
    .err { color: #b00020; margin: 6px 0; }
  </style>
</head>
<body>
  <h1>To-Do List</h1>
  <div class="toolbar">
    <label>
      Filter:
      <select id="filter">
        <option value="all">All</option>
        <option value="true">Completed</option>
        <option value="false">Active</option>
      </select>
    </label>
    <span id="status" class="small muted"></span>
  </div>

  <ul id="todo-list"></ul>

  <form id="todo-form">
    <input type="text" id="title" placeholder="Title" required />
    <input type="text" id="description" placeholder="Description" required />
    <button type="submit">Add To-Do</button>
  </form>

  <div id="error" class="err" role="alert" style="display:none;"></div>

  <footer>
    <small>Todo App <span id="app-version">v?.?.?</span></small>
  </footer>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const listEl = $("#todo-list");
    const filterEl = $("#filter");
    const statusEl = $("#status");
    const errEl = $("#error");
    const verEl = $("#app-version");

    async function getVersion() {
      try {
        const r = await fetch('/version');
        const j = await r.json();
        verEl.textContent = 'v' + (j.version || 'unknown');
      } catch {}
    }

    function showError(msg) {
      errEl.textContent = msg;
      errEl.style.display = 'block';
      setTimeout(() => (errEl.style.display = 'none'), 3000);
    }

    async function fetchTodos() {
      const q = filterEl.value;
      const qs = q === 'all' ? '' : `?completed=${q}`;
      const response = await fetch('/todos' + qs);
      const todos = await response.json();

      listEl.innerHTML = '';
      statusEl.textContent = `${todos.length} item(s)`;

      todos.forEach(todo => {
        const li = document.createElement('li');
        if (todo.completed) li.classList.add('done');

        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.checked = !!todo.completed;
        chk.title = 'Toggle completed';
        chk.onchange = async () => {
          await updateTodo(todo.id, todo.title, todo.description, chk.checked);
          fetchTodos();
        };

        const span = document.createElement('span');
        span.textContent = `${todo.title}: ${todo.description}`;

        const editButton = document.createElement('button');
        editButton.textContent = 'Edit';
        editButton.onclick = async () => {
          const title = prompt('Enter new title:', todo.title);
          if (title === null) return;
          const description = prompt('Enter new description:', todo.description);
          if (description === null) return;
          const ok = await updateTodo(todo.id, title, description, chk.checked);
          if (ok) fetchTodos();
        };

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Delete';
        deleteButton.onclick = async () => {
          const yes = confirm('Delete this item?');
          if (!yes) return;
          const r = await fetch(`/todos/${todo.id}`, { method: 'DELETE' });
          if (r.ok) fetchTodos(); else showError('Delete failed');
        };

        li.append(chk, span, editButton, deleteButton);
        listEl.appendChild(li);
      });
    }

    async function updateTodo(id, title, description, completed) {
      try {
        const r = await fetch(`/todos/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, title, description, completed })
        });
        if (!r.ok) {
          const j = await r.json().catch(() => ({}));
          showError(j.detail || 'Update failed');
        }
        return r.ok;
      } catch {
        showError('Network error');
        return false;
      }
    }

    document.getElementById('todo-form').addEventListener('submit', async (event) => {
      event.preventDefault();
      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();
      if (!title || !description) {
        showError('Title/Description required');
        return;
      }
      const response = await fetch('/todos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: Date.now(), title, description, completed: false })
      });
      if (response.ok) {
        event.target.reset();
        fetchTodos();
      } else {
        const j = await response.json().catch(() => ({}));
        showError(j.detail || 'Create failed');
      }
    });

    filterEl.addEventListener('change', fetchTodos);

    getVersion();
    fetchTodos();
  </script>
</body>
</html>
