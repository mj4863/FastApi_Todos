<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>To-Do List</title>
  <style>
    /* ===== Design Tokens ===== */
    :root{
      --bg:#f6f7fb; --fg:#0f1222; --muted:#6b7280;
      --card:#fff; --border:#e6e8f0; --shadow:0 8px 30px rgba(0,0,0,.06);
      --primary:#6366f1; --primary-weak:#eef2ff; --danger:#ef4444;
      --radius:14px; --ring:0 0 0 3px rgba(99,102,241,.25);
      color-scheme:light dark;
    }
    body.dark{
      --bg:#0b0d14; --fg:#e5e7eb; --muted:#9aa0aa;
      --card:#0f1420; --border:#1f2430; --shadow:0 8px 30px rgba(0,0,0,.4);
      --primary:#8b93ff; --primary-weak:#111634; --danger:#ff6b6b;
      --ring:0 0 0 3px rgba(139,147,255,.25);
    }

    /* ===== Base ===== */
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      color:var(--fg); background:var(--bg);
      display:grid; place-items:start center; padding:clamp(16px,3vw,32px);
    }
    .app{
      width:min(860px,100%); background:var(--card); border:1px solid var(--border);
      border-radius:calc(var(--radius) + 2px); box-shadow:var(--shadow); overflow:hidden;
    }
    header,.toolbar,footer{ padding:16px clamp(16px,3vw,24px); }
    header{ display:flex; gap:10px; align-items:center; border-bottom:1px solid var(--border)}
    h1{ margin:0; font-size:clamp(20px,2.4vw,28px) }
    .badge{ padding:2px 8px; border-radius:999px; border:1px solid var(--border);
      background:var(--primary-weak); color:var(--primary); font-size:12px }

    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; border-bottom:1px solid var(--border)}
    .spacer{ flex:1 1 auto }
    label,select{ font-size:14px; color:var(--muted) }
    select{
      appearance:none; border:1px solid var(--border); background:transparent; color:var(--fg);
      padding:8px 12px; border-radius:10px; outline:none;
    }
    select:focus-visible{ box-shadow:var(--ring) }

    .icon-btn{
      height:36px; width:36px; display:grid; place-items:center; border-radius:50%;
      border:1px solid var(--border); background:transparent; cursor:pointer;
    }
    .icon-btn:hover{ background:var(--primary-weak) }

    #status{
      color:var(--muted); font-size:13px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
    }

    main{ padding:10px clamp(16px,3vw,24px) 20px }

    /* ===== List ===== */
    ul#todo-list{ margin:0; padding:0; list-style:none; display:grid; gap:10px }
    li.todo{
      display:grid; grid-template-columns:auto 1fr auto auto; align-items:center; gap:10px;
      border:1px solid var(--border); border-radius:var(--radius); padding:10px 12px; background:transparent;
    }
    input[type="checkbox"]{ width:20px; height:20px; accent-color:var(--primary); cursor:pointer }
    .text{ overflow:hidden; white-space:nowrap; text-overflow:ellipsis }
    .done .text{ text-decoration:line-through; opacity:.85 }
    .btn{ border:1px solid var(--border); background:transparent; color:var(--fg);
      padding:8px 12px; border-radius:10px; cursor:pointer }
    .btn:hover{ background:var(--primary-weak) }
    .btn.danger{ color:var(--danger); border-color:transparent; background:transparent }
    .btn.danger:hover{ background:rgba(239,68,68,.08) }

    /* ===== Form / Error / Footer ===== */
    form{
      display:grid; grid-template-columns:1fr 1fr auto; gap:10px; align-items:center;
      border-top:1px dashed var(--border); padding-top:14px
    }
    input[type="text"]{
      border:1px solid var(--border); background:transparent; color:var(--fg);
      padding:10px 12px; border-radius:10px; outline:none;
    }
    input[type="text"]::placeholder{ color:var(--muted) }
    input[type="text"]:focus-visible{ box-shadow:var(--ring); border-color:var(--primary) }

    .err{
      margin-top:10px; color:#b00020; background:#ffeff2; border:1px solid #ffd0d8;
      padding:10px 12px; border-radius:10px; display:none
    }
    body.dark .err{ background:#2a0f17; border-color:#3b0f19; color:#ff98a7 }

    footer{ border-top:1px solid var(--border); display:flex; justify-content:space-between; color:var(--muted) }
    
    .inline-input{
      border:1px solid var(--border);
      background:transparent;
      color:var(--fg);
      padding:6px 8px;
      border-radius:8px;
      outline:none;
      min-width: 120px;
    }
    .inline-input:focus-visible{ box-shadow:var(--ring); border-color:var(--primary) }

    /* Year/Month Picker Popup */
    .picker-pop{
      position:absolute;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px;
      box-shadow:var(--shadow);
      color:var(--fg); /* ‚úÖ Ï∂îÍ∞Ä: Îã§ÌÅ¨ Î™®Îìú ÎåÄÎπÑ Ïú†ÏßÄ */
      z-index:10;
    }

    .picker-title{
      font-weight:600;
      margin-bottom:6px;
      color:var(--fg); /* ‚úÖ Í∏ÄÏûêÏÉâ Î™ÖÏãú */
    }

    .picker-chip{
      border:1px solid var(--border);
      background:transparent;
      border-radius:8px;
      padding:6px 8px;
      cursor:pointer;
      color:var(--fg); /* ‚úÖ Ï∂îÍ∞Ä */
      transition:background 0.2s ease, color 0.2s ease;
    }

    .picker-chip:hover{
      background:var(--primary-weak);
      color:var(--fg);
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>To-Do List</h1>
      <span class="badge" id="app-version">v?.?.?</span>
    </header>

    <div class="toolbar">
      <label>
        Filter:
        <select id="filter">
          <option value="all">All</option>
          <option value="true">Completed</option>
          <option value="false">Active</option>
        </select>
      </label>
      <div id="calendar" style="margin-left:10px"></div>
      <div class="spacer"></div>
      <button id="toggle-theme" class="icon-btn" title="Toggle dark mode">üåì</button>
      <span id="status" role="status" aria-live="polite"></span>
    </div>

    <main>
      <ul id="todo-list" role="list"></ul>

      <form id="todo-form" autocomplete="off">
        <input id="title" placeholder="Title" required />
        <input id="description" placeholder="Description" required />
        <button class="btn" type="submit">Add</button>
      </form>

      <div id="error" class="err" role="alert"></div>
    </main>

    <footer>
      <small>Made with FastAPI</small>
      <small>Press üåì to toggle theme</small>
    </footer>
  </div>

  <!-- Template reduces DOM boilerplate -->
  <template id="todo-tpl">
    <li class="todo" data-id="">
      <input class="chk" type="checkbox" />
      <span class="text"></span>
      <button class="btn edit" type="button">Edit</button>
      <button class="btn danger del" type="button">Delete</button>
    </li>
  </template>

  <script>
    // ===== State & Storage =====
    const $ = s => document.querySelector(s);
    const els = {
      list: $("#todo-list"), filter: $("#filter"), status: $("#status"),
      err: $("#error"), ver: $("#app-version"), themeBtn: $("#toggle-theme"),
      form: $("#todo-form"), title: $("#title"), desc: $("#description"),
      tpl: /** @type {HTMLTemplateElement} */ ($("#todo-tpl")),
      cal: $("#calendar"),
    };

    // ÎÇ†Ïßú Ìó¨Ìçº
    const todayISO = () => new Date().toISOString().slice(0,10); // YYYY-MM-DD
    const iso = (y,m,d) => `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const STORE = { FILTER:'todo-filter', THEME:'todo-theme', DATE:'todo-date' };
    
    const state = {
      get filter(){ return localStorage.getItem(STORE.FILTER) || 'all'; },
      set filter(v){ localStorage.setItem(STORE.FILTER, v); },
      get theme(){ return localStorage.getItem(STORE.THEME) || 'light'; },
      set theme(v){ localStorage.setItem(STORE.THEME, v); },
      get date(){ return localStorage.getItem(STORE.DATE) || todayISO(); },
      set date(v){ localStorage.setItem(STORE.DATE, v); },
      viewMonth: null, // {y,m} ÌòÑÏû¨ Îã¨Î†•Ïóê ÌëúÏãúÏ§ëÏù∏ Ïõî
    };
    if (state.theme === 'dark') document.body.classList.add('dark');
    els.filter.value = state.filter;

    // API: ÎÇ†Ïßú/ÌïÑÌÑ∞ Ï°∞Ìï©
    const api = {
      async request(path, opts){
        const r = await fetch(path, { headers:{'Content-Type':'application/json'}, ...opts });
        if (!r.ok){
          let msg = 'Request failed';
          try { const j = await r.json(); msg = j.detail || msg; } catch {}
          throw new Error(msg);
        }
        return r.status === 204 ? null : r.json();
      },

      list(date, filter){
        const q = new URLSearchParams();
        if (date) q.set('date', date);
        if (filter !== 'all') q.set('completed', filter);
        const qs = q.toString(); 
        return this.request(`/todos${qs ? `?${qs}` : ''}`);
      },

      updateDate(id, date){
        return this.request(`/todos/${id}/date`, {
          method: 'PATCH',
          body: JSON.stringify({ date })
        });
      },

      create(todo){ return this.request('/todos', { method:'POST', body:JSON.stringify(todo) }); },
      update(id, todo){ return this.request(`/todos/${id}`, { method:'PUT', body:JSON.stringify(todo) }); },
      remove(id){ return this.request(`/todos/${id}`, { method:'DELETE' }); },
      version(){ return this.request('/version'); }
    };

    // ===== UI helpers =====
    function showError(msg){
      els.err.textContent = msg; els.err.style.display = 'block';
      clearTimeout(showError.tid); showError.tid = setTimeout(()=> els.err.style.display='none', 3000);
    }
    const plural = (n, w) => `${n} ${w}${n===1?'':'s'}`;

    // Î¶¨Ïä§Ìä∏ Î†åÎçî (data-date Î≥¥Ï°¥)
    function renderList(todos){
      els.list.textContent = '';
      if (!todos.length){
        const empty = document.createElement('li');
        empty.className = 'todo'; empty.style.borderStyle='dashed'; empty.style.opacity='.7';
        empty.innerHTML = `<span class="text">No items on ${state.date}. Add your first to-do!</span>`;
        els.list.appendChild(empty);
        els.status.textContent = `0 items ‚Ä¢ 0 done ‚Ä¢ ${state.date}`;
        return;
      }
      const frag = document.createDocumentFragment();
      let done = 0;
      for (const t of todos){
        if (t.completed) done++;
        const node = els.tpl.content.firstElementChild.cloneNode(true);
        node.dataset.id = t.id;
        node.dataset.date = t.date;                // ÎÇ†Ïßú Ï†ÄÏû•
        node.dataset.title = t.title;           
        node.dataset.description = t.description;
        if (t.completed) node.classList.add('done');
        node.querySelector('.chk').checked = !!t.completed;
        node.querySelector('.text').textContent = `${t.title}: ${t.description}`;

        // Move Î≤ÑÌäº Ï∂îÍ∞Ä
        const delBtn = node.querySelector('.del');
        const moveBtn = document.createElement('button');
        moveBtn.className = 'btn move';
        moveBtn.type = 'button';
        moveBtn.textContent = 'Move';
        delBtn.before(moveBtn);

        frag.appendChild(node);
      }
      els.list.appendChild(frag);
      els.status.textContent = `${todos.length} items ‚Ä¢ ${done} done ‚Ä¢ ${state.date}`;
    }

    // Îã¨Î†• Î†åÎçî (Ïó∞/Ïõî Îπ†Î•∏ Ïù¥Îèô + ÏùºÏöîÏùº ÏãúÏûë)
    function renderCalendar(){
      // ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
      const [selY, selM] = state.date.split('-').map(Number);
      if (!state.viewMonth) state.viewMonth = { y: selY, m: selM };

      const { y, m } = state.viewMonth; // m: 1~12
      const first = new Date(y, m-1, 1);
      const last  = new Date(y, m,   0);
      const startWeekday = first.getDay(); // 0=Sun ~ 6=Sat
      const days = last.getDate();

      // Î£®Ìä∏ ÎπÑÏö∞Í∏∞
      els.cal.textContent = '';
      els.cal.style.position = 'relative';

      // ===== Ìó§Îçî =====
      const hdr = document.createElement('div');
      hdr.style.display='flex';
      hdr.style.gap='8px';
      hdr.style.alignItems='center';
      hdr.style.marginBottom='6px';

      const yPrev = document.createElement('button'); yPrev.className='btn'; yPrev.textContent='¬´';
      const mPrev = document.createElement('button'); mPrev.className='btn'; mPrev.textContent='‚Äπ';

      const titleBtn = document.createElement('button');
      titleBtn.className='btn';
      titleBtn.textContent = `${y}-${String(m).padStart(2,'0')} ‚ñº`;
      titleBtn.style.cursor = 'pointer';
      titleBtn.title = 'Click to choose year/month';

      const mNext = document.createElement('button'); mNext.className='btn'; mNext.textContent='‚Ä∫';
      const yNext = document.createElement('button'); yNext.className='btn'; yNext.textContent='¬ª';

      hdr.append(yPrev, mPrev, titleBtn, mNext, yNext);
      els.cal.appendChild(hdr);

      // ===== ÌåùÏò§Î≤Ñ (Ïó∞/Ïõî ÏÑ†ÌÉù) =====
      let pop = null;
      let docHandler = null;

      function closePicker(){
        if (pop && pop.parentNode) pop.parentNode.removeChild(pop);
        pop = null;
        if (docHandler){
          document.removeEventListener('click', docHandler, true);
          docHandler = null;
        }
      }

      function openPicker(){
        closePicker(); // ÌïòÎÇòÎßå Ïó¥Î¶¨ÎèÑÎ°ù

        // ÌòÑÏû¨ Î≥¥Ïù¥Îäî Ïó∞ÎèÑ Î¨∂ÏùåÏùò ÏãúÏûë Ïó∞ÎèÑ(12ÎÖÑ Îã®ÏúÑ ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò)
        let yearStart = y - 6; // Ï§ëÏïôÏ†ïÎ†¨ ÎäêÎÇå(ÌòÑÏû¨ yÍ∞Ä Í∞ÄÏö¥Îç∞ÏØ§)

        // ÌåùÏò§Î≤Ñ DOM
        pop = document.createElement('div');
        pop.className = 'picker-pop';

        // ÏÉÅÎã® Î∞î: Ïù¥Ï†Ñ/Îã§Ïùå ÌéòÏù¥ÏßÄ Î≤ÑÌäº + ÌÉÄÏù¥ÌãÄ
        const topRow = document.createElement('div');
        topRow.style.display='flex';
        topRow.style.alignItems='center';
        topRow.style.justifyContent='space-between';
        topRow.style.gap='8px';

        const prevYears = document.createElement('button');
        prevYears.className = 'btn';
        prevYears.textContent = '‚ü®';

        const title = document.createElement('div');
        title.className = 'picker-title';
        // title ÌÖçÏä§Ìä∏Îäî renderYearGridÏóêÏÑú ÏÑ∏ÌåÖ

        const nextYears = document.createElement('button');
        nextYears.className = 'btn';
        nextYears.textContent = '‚ü©';

        topRow.append(prevYears, title, nextYears);
        pop.appendChild(topRow);

        // Ïó∞ÎèÑ Í∑∏Î¶¨Îìú
        const yGrid = document.createElement('div');
        yGrid.className = 'picker-grid';
        pop.appendChild(yGrid);

        // ÌïòÎã® Î≤ÑÌäºÎì§
        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn';
        closeBtn.textContent = 'Close';
        closeBtn.style.marginTop = '8px';
        closeBtn.addEventListener('click', closePicker);
        pop.appendChild(closeBtn);

        // Í∑∏Î¶¨Îìú Í∑∏Î¶¨Îäî Ìï®Ïàò (ÌòÑÏû¨ yearStart Í∏∞Ï§Ä 12Í∞ú)
        function renderYearGrid(){
          const years = Array.from({length: 12}, (_,i)=> yearStart + i);
          // ÌÉÄÏù¥ÌãÄ: Î≤îÏúÑ ÌëúÏãú
          title.textContent = `${years[0]} ‚Äì ${years[years.length-1]}`;

          yGrid.textContent = '';
          years.forEach(Y=>{
            const chip = document.createElement('button');
            chip.className = 'picker-chip';
            chip.textContent = String(Y);
            if (Y === y) chip.style.boxShadow = 'var(--ring)'; // ÌòÑÏû¨ ÌëúÏãú Ï§ëÏù∏ Ïó∞ÎèÑ ÌïòÏù¥ÎùºÏù¥Ìä∏
            chip.addEventListener('click', ()=> renderMonthPicker(Y));
            yGrid.appendChild(chip);
          });
        }

        // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò: 12ÎÖÑ Îã®ÏúÑ Ïù¥Îèô
        prevYears.addEventListener('click', ()=>{
          yearStart -= 12;
          renderYearGrid();
        });
        nextYears.addEventListener('click', ()=>{
          yearStart += 12;
          renderYearGrid();
        });

        // ÌåùÏò§Î≤Ñ ÏúÑÏπò: Ï†úÎ™© Î≤ÑÌäº ÏïÑÎûò
        const rect = titleBtn.getBoundingClientRect();
        const calRect = els.cal.getBoundingClientRect();
        pop.style.top  = `${(rect.bottom - calRect.top) + 4}px`;
        pop.style.left = `${(rect.left   - calRect.left)}px`;

        els.cal.appendChild(pop);

        // Î∞îÍπ• ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞ (Ï§ëÎ≥µ Îì±Î°ù Î∞©ÏßÄ)
        docHandler = (e)=>{
          if (!pop) return;
          if (!pop.contains(e.target) && e.target !== titleBtn) closePicker();
        };
        document.addEventListener('click', docHandler, true);

        // ÏµúÏ¥à Î†åÎçî
        renderYearGrid();
      }

      function renderMonthPicker(targetYear){
        pop.textContent = '';

        const t = document.createElement('div');
        t.className = 'picker-title';
        t.innerHTML = `<span>${targetYear} ‚Äî Select Month</span>`;
        pop.appendChild(t);

        const mGrid = document.createElement('div');
        mGrid.className = 'picker-grid';
        for (let mm=1; mm<=12; mm++){
          const chip = document.createElement('button');
          chip.className = 'picker-chip';
          chip.textContent = String(mm).padStart(2,'0');
          if (targetYear === y && mm === m) chip.style.boxShadow = 'var(--ring)';
          chip.addEventListener('click', ()=>{
            state.viewMonth = { y: targetYear, m: mm };
            renderCalendar(); // Îã¨Î†• Î¶¨Î†åÎçî
            closePicker();
          });
          mGrid.appendChild(chip);
        }
        pop.appendChild(mGrid);

        const backRow = document.createElement('div');
        backRow.style.display='flex';
        backRow.style.justifyContent='space-between';
        backRow.style.marginTop='8px';

        const backBtn = document.createElement('button');
        backBtn.className = 'btn'; backBtn.textContent = 'Back to Years';
        backBtn.addEventListener('click', openPicker);

        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn'; closeBtn.textContent = 'Close';
        closeBtn.addEventListener('click', closePicker);

        backRow.append(backBtn, closeBtn);
        pop.appendChild(backRow);
      }

      titleBtn.addEventListener('click', ()=>{
        if (pop) closePicker(); else openPicker();
      });

      // Ïó∞/Ïõî Ïù¥Îèô Î≤ÑÌäº
      yPrev.addEventListener('click', ()=>{ state.viewMonth = { y: y-1, m }; renderCalendar(); });
      yNext.addEventListener('click', ()=>{ state.viewMonth = { y: y+1, m }; renderCalendar(); });
      mPrev.addEventListener('click', ()=>{ const nm = m===1 ? 12 : m-1; const ny = m===1 ? y-1 : y; state.viewMonth = { y: ny, m: nm }; renderCalendar(); });
      mNext.addEventListener('click', ()=>{ const nm = m===12 ? 1 : m+1; const ny = m===12 ? y+1 : y; state.viewMonth = { y: ny, m: nm }; renderCalendar(); });

      // ===== ÏöîÏùº Ìó§Îçî + ÎÇ†Ïßú Í∑∏Î¶¨Îìú =====
      const grid = document.createElement('div');
      grid.style.display='grid';
      grid.style.gridTemplateColumns='repeat(7, minmax(28px, 1fr))';
      grid.style.gap='6px';

      const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']; // ÏùºÏöîÏùº ÏãúÏûë
      for (const w of weekdays){
        const c = document.createElement('div');
        c.style.fontSize='12px';
        c.style.color='var(--muted)';
        c.textContent = w;
        grid.appendChild(c);
      }

      // ÎπàÏπ∏
      for (let i=0; i<startWeekday; i++) grid.appendChild(document.createElement('div'));

      for (let d=1; d<=days; d++){
        const btn = document.createElement('button');
        btn.className='btn';
        btn.textContent = d;
        const thisISO = iso(y,m,d);
        btn.dataset.date = thisISO;
        if (thisISO === state.date){
          btn.style.borderColor='var(--primary)';
          btn.style.boxShadow='var(--ring)';
        }
        btn.addEventListener('click', ()=>{
          state.date = thisISO;
          load();                  // Î™©Î°ù Í∞±Ïã†
          state.viewMonth = { y, m }; // Ïõî Ïú†ÏßÄ
          renderCalendar();
        });
        grid.appendChild(btn);
      }

      els.cal.appendChild(grid);
    }

    // ===== Actions =====
    async function load(){
      try {
        const todos = await api.list(state.date, state.filter);
        renderList(todos);
      } catch(e){ showError(e.message); }
    }

    function makeInput(value, placeholder){
      const i = document.createElement('input');
      i.type = 'text';
      i.className = 'inline-input';
      i.value = value ?? '';
      i.placeholder = placeholder ?? '';
      return i;
    }

    function startEdit(li){
      if (li.classList.contains('editing')) return;
      li.classList.add('editing');

      const textEl = li.querySelector('.text');
      const chk = li.querySelector('.chk');
      const editBtn = li.querySelector('.btn.save, .btn.edit') || li.querySelector('.edit');
      const delBtn = li.querySelector('.del');

      const curTitle = li.dataset.title ?? '';
      const curDesc  = li.dataset.description ?? '';
      const curDate  = li.dataset.date || state.date;   // ÌòÑÏû¨ ÎÇ†Ïßú

      li.dataset._origTitle = curTitle;
      li.dataset._origDesc  = curDesc;
      li.dataset._origDate  = curDate;

      const wrap = document.createElement('span');
      wrap.className = 'inline-wrap';
      const titleInput = makeInput(curTitle, 'Title');
      const descInput  = makeInput(curDesc,  'Description');
      
      titleInput.name = 'edit-title';
      descInput.name  = 'edit-desc';

      // ÎÇ†Ïßú ÏûÖÎ†• Ï∂îÍ∞Ä
      const dateInput = document.createElement('input');
      dateInput.type = 'date';
      dateInput.className = 'inline-input';
      dateInput.value = curDate;
      dateInput.name = 'edit-date';
      dateInput.style.minWidth = '140px';

      wrap.append(titleInput, descInput, dateInput);
      textEl.replaceWith(wrap);

      chk.disabled = true;

      editBtn.textContent = 'Save';
      editBtn.classList.add('save');
      editBtn.classList.remove('edit');

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn cancel';
      cancelBtn.type = 'button';
      cancelBtn.textContent = 'Cancel';
      delBtn.before(cancelBtn);

      function onKey(e){
        if (e.key === 'Enter'){ saveEdit(li); }
        else if (e.key === 'Escape'){ cancelEdit(li); }
      }
      titleInput.addEventListener('keydown', onKey);
      descInput.addEventListener('keydown', onKey);
      dateInput.addEventListener('keydown', onKey);

      titleInput.focus();
    }

    async function saveEdit(li){
      const id = Number(li.dataset.id);
      const completed = li.classList.contains('done');

      const title = li.querySelector('input[name="edit-title"]')?.value.trim() ?? '';
      const description = li.querySelector('input[name="edit-desc"]')?.value.trim() ?? '';
      // ÎÇ†Ïßú ÏùΩÍ∏∞ (ÏóÜÏúºÎ©¥ Í∏∞Ï°¥Í∞í Ïú†ÏßÄ)
      const date = li.querySelector('input[name="edit-date"]')?.value || (li.dataset.date || state.date);

      if (!title || !description){
        showError('Title/Description required');
        return;
      }

      try{
        await api.update(id, { id, title, description, completed, date });
        await load();
      } catch(err){
        showError(err.message);
      }
    }

    function cancelEdit(li){
      const origTitle = li.dataset._origTitle ?? '';
      const origDesc  = li.dataset._origDesc ?? '';
      const origDate = (li.dataset._origDate ?? li.dataset.date) || state.date;

      const wrap = li.querySelector('.inline-wrap');
      const textEl = document.createElement('span');
      textEl.className = 'text';
      textEl.textContent = `${origTitle}: ${origDesc}`;
      wrap.replaceWith(textEl);

      const saveBtn = li.querySelector('.save');
      if (saveBtn){ saveBtn.textContent = 'Edit'; saveBtn.classList.add('edit'); saveBtn.classList.remove('save'); }
      const cancelBtn = li.querySelector('.cancel'); if (cancelBtn) cancelBtn.remove();

      const chk = li.querySelector('.chk'); chk.disabled = false;

      // datasetÎèÑ ÏõêÎ≥µ
      li.dataset.title = origTitle;
      li.dataset.description = origDesc;
      li.dataset.date = origDate;

      li.classList.remove('editing');
    }


    // Ï≤¥ÌÅ¨Î∞ïÏä§ ÌÜ†Í∏Ä ‚Üí date Ìè¨Ìï®Ìï¥ÏÑú ÏóÖÎç∞Ïù¥Ìä∏
    els.list.addEventListener('change', async (e)=>{
      const chk = e.target.closest('.chk'); if (!chk) return;
      const li = e.target.closest('.todo');
      const id = Number(li.dataset.id);
      const title = li.dataset.title ?? '';
      const description = li.dataset.description ?? '';
      const date = li.dataset.date || state.date;
      try { await api.update(id, { id, title, description, completed: chk.checked, date }); load(); }
      catch(err){ showError(err.message); chk.checked = !chk.checked; }
    });

    // Ìé∏Ïßë/ÏÇ≠Ï†ú ‚Üí date Î≥¥Ï°¥
    els.list.addEventListener('click', async (e)=>{
      const li = e.target.closest('.todo'); if (!li) return;
      const id = Number(li.dataset.id);
      const date = li.dataset.date || state.date;

      if (e.target.closest('.edit')){              // Í∏∞Ï°¥: Edit ‚Üí Ïù∏ÎùºÏù∏ Ìé∏Ïßë ÏãúÏûë
        startEdit(li);
        return;
      }
      if (e.target.closest('.save')){              // ÏÉàÎ°ú Ï∂îÍ∞Ä: Save ‚Üí Ï†ÄÏû•
        await saveEdit(li);
        return;
      }
      if (e.target.closest('.cancel')){            // ÏÉàÎ°ú Ï∂îÍ∞Ä: Cancel ‚Üí Ï∑®ÏÜå
        cancelEdit(li);
        return;
      }
      
      if (e.target.closest('.move')){
        // Í∞ÑÎã®Ìûà promptÎ°ú ÎÇ†Ïßú Î∞õÍ∏∞ (YYYY-MM-DD)
        const current = li.dataset.date || state.date;
        const newDate = prompt('Move to date (YYYY-MM-DD):', current);
        if (!newDate) return;

        try{
          await api.updateDate(id, newDate); // PATCH Ìò∏Ï∂ú
          state.date = newDate;   // ‚Üê Ïù¥ÎèôÌïú ÎÇ†ÏßúÎ°ú Îã¨Î†•/Î¶¨Ïä§Ìä∏ÎèÑ Ï†ÑÌôò
          await load();                      // ÏÉà ÎÇ†ÏßúÏóê ÎßûÏ∂∞ Î™©Î°ù Í∞±Ïã†
        }catch(err){
          showError(err.message);
        }
        return;
      }

      if (e.target.closest('.del')){
        if (!confirm('Delete this item?')) return;
        try { await api.remove(id); load(); } catch(err){ showError(err.message); }
      }
    });

    // ÏÉà Ìï≠Î™© Ï∂îÍ∞Ä Ïãú ÌòÑÏû¨ ÏÑ†ÌÉù ÎÇ†ÏßúÎ°ú ÏÉùÏÑ±
    els.form.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const title = els.title.value.trim(); const description = els.desc.value.trim();
      if (!title || !description) return showError('Title/Description required');
      const todo = { id: Date.now(), title, description, completed:false, date: state.date };
      try { await api.create(todo); els.form.reset(); els.title.focus(); load(); }
      catch(err){ showError(err.message); }
    });

    els.filter.addEventListener('change', ()=>{ state.filter = els.filter.value; load(); });
    els.themeBtn.addEventListener('click', ()=>{
      document.body.classList.toggle('dark');
      state.theme = document.body.classList.contains('dark') ? 'dark' : 'light';
    });

    // Î∂ÄÌåÖ
    (async function boot(){
      try { const v = await api.version(); els.ver.textContent = 'v'+(v.version||'unknown'); } catch {}
      renderCalendar();   // Îã¨Î†• Î®ºÏ†Ä
      await load();       // ÏÑ†ÌÉùÏùºÏûê Î™©Î°ù Î°úÎìú
    })();


  </script>
</body>
</html>
